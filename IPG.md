---
id: IPG
title: راهنمای فنی اتصال و راه‌اندازی درگاه پرداخت اینترنتی دماوند
sidebar_label: درگاه پرداخت اینترنتی
custom_edit_url: https://github.com/ecdco/docs/edit/master/IPG.md
---

نسخه ۲٫۰

## مقدمه

شرکت الکترونیک کارت دماوند به منظور سهولت در امر پرداخت اینترنتی اقدام به راه‌اندازی سرویس درگاه پرداخت اینترنتی (IPG) نموده است. این سرویس به پذیرندگان امکان می‌دهد تا هزینه ارائه خدمات یا فروش محصولات خود را از بستر اینترنت با تمامی کارت‌های عضو سامانه شتاب دریافت نمایند.

برای دریافت مجوز دسترسی و راه‌اندازی درگاه پرداخت شرکت الکترونیک کارت دماوند، کافی است متقاضی از طریق  صفحه درخواست پایانه دماوند به نشانی  [ecd-co.ir/terminal](http://www.ecd-co.ir/terminal?type=ipg) درخواست خود را اعلام کند. پس از ثبت و تایید درخواست توسط شرکت، درخواست‌دهنده که از این پس «پذیرنده» نامیده می‌شود، می‌تواند اقدام به راه‌اندازی درگاه اینترنتی دماوند نماید. برای آشنایی با مدارک مورد نیاز و چگونگی ثبت درخواست به مستند «[چگونگی درخواست پایانه](TerminalRequest.md)» مراجعه نمایید.

پس از تایید،‌ پذیرنده اطلاعات ذیل را دریافت خواهد کرد:

-  شماره پذیرندگی (Merchant Number)
-  شماره پایانه (Terminal Number)
-  کلید (Key) - این مقدار می‌بایست به صورت کاملا محرمانه نزد پذیرنده نگهداری شود.

در حال حاضر وب‌سایت پذیرنده الزامی به داشتن گواهینامه امنیتی SSL ندارد ولی استفاده از این گواهینامه به منظور داشتن هر چه بیشتر امنیت توصیه می‌شود. 


در ادامه این مستند به معرفی و شرح توابع وب‌سرویس پرداخت اینترنتی دماوند پرداخته می‌شود. قابل ذکر است که این وب سرویس مبتنی بر **RESTful API** می‌باشد.


## شروع

عملیات پرداخت از طریق درگاه اینترنتی دماوند در پنج مرحله زیر انجام می‌گیرد:

-  دریافت توکن پرداخت توسط پذیرنده
-  هدایت مشتری به همراه توکن از سمت وب‌سایت پذیرنده به سمت صفحه درگاه پرداخت دماوند
-  پرداخت مبلغ درخواستی پذیرنده توسط مشتری
-  بازگشت مشتری از صفحه درگاه پرداخت به وب‌سایت پذیرنده به همراه اطلاعات مربوط به نتیجه پرداخت
-  تصمیم پذیرنده مبنی بر تایید یا رد پرداخت

نقطه شروع تبادل اطلاعات بین وب‌سایت پذیرنده و وب‌سرویس دماوند، دریافت توکن (Token) می‌باشد. پذیرنده با ارسال اطلاعات تراکنش مورد نظر خود به وب سرویس دماوند، یک توکن دریافت می‌کند که این توکن برای هر تراکنش منحصر‌به‌فرد بوده و باید تا پایان نزد پذیرنده حفظ شود.

**پذیرنده می‌بایست در ازای هر تراکنش (یا فروش خود)، یک توکن مجزا دریافت کند و حداقل تا پایان عملیات پرداخت آن را نزد خود حفظ نماید.**

در تمامی ارتباطات بین وب‌سایت پذیرنده و وب‌سرویس دماوند، IP سرور پذیرنده بررسی می‌شود و اگر با IP داده شده به شرکت در زمان ثبت درخواست متفاوت باشد، IP سرور پذیرنده بلاک می‌شود و برای رفع مسدودی احتمالی باید با مرکز تماس دماوند صحبت نمایید.


## دریافت توکن

| عنوان | توضیحات |
|-|-|
| نام تابع | ```PayRequest``` |
| نشانی کامل تابع | ```https://ecd.shaparak.ir/ipg_ecd/PayRequest``` |
| نوع تابع | POST |

### مقادیر ارسالی به تابع ```PayRequest```


```json
{
    "TerminalNumber": "99999999",
    "BuyID": "9897676",
    "Amount": 10000,
    "Date": "2018/02/02",
    "Time": "13:22",
    "RedirectURL": "https://example.com/back", 
    "Language": "fa",
    "CheckSum": "356A192B7913B04C54574D18C28D46E6395428AB"
}
```

| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```TerminalNumber``` | ```String``` | شماره پایانه پذیرنده ‌ |
| ```BuyID``` | ```String``` | شناسه خرید - این مقدار به اختیار پذیرنده تنظیم می‌شود (حداکثر 40 کاراکتر که می‌تواند شامل اعداد و حروف انگلیسی باشد) ‌ |
| ```Amount``` | ```Long``` | مبلغ خرید به واحد ریال ‌ |
| ```Date``` | ```String``` | تاریخ انجام تراکنش به میلادی و قالب: ```yyyy/mm/dd``` ‌ |
| ```Time``` | ```String``` | زمان انجام تراکنش با قالب: ```HH:mm``` ‌ |
| ```RedirectURL``` | ```String``` | نشانی بازگشت به وب‌سایت پذیرنده ‌ |
| ```Language``` | ```String``` | تنظیم زبان درگاه پرداخت: ```"fa"``` برای فارسی و ```"en"```: برای انگلیسی ‌ |
| ```CheckSum``` | ```String``` | مقدار کنترلی درخواست توکن ‌ |

-  تضمین یکتایی «شناسه خرید» (```BuyID```) بر عهده پذیرنده خواهد بود.
-  «نشانی بازگشت به وب‌سایت پذیرنده» (```RedirectURL```)، باید با «نشانی بازگشت» داده شده به شرکت در زمان ثبت درخواست یکسان باشد یا با آن نشانی شروع شود.
-  مقدار کنترلی (```CheckSum```) یک کد Hash شده با الگوریتم ```SHA1``` است که باید با ساختار زیر ایجاد شود:
```text
TerminalNumber + BuyID + Amount + Date + Time + RedirectURL + Key
```


```php
// PHP Sample
$checkSum = sha1($terminalNumber . $buyID . $amount . $date . $time . $redirectURL . $key);
```

### مقادیر دریافتی از تابع ```PayRequest```


```json
{
    "State": 1,
    "Res": "C5B2E37396DCC3B654D226FC937BC01F628EC968",
    "ErrorDescription": "", 
    "ErrorCode": ""
}
```


| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```State``` | ```Integer``` | نتیجه عملیات: ```1```: موفق و ```0```: ناموفق ‌ |
| ```Res``` | ```String``` | در صورت موفق بودن عملیات مقدار توکن در این متغیر قرار خواهد گرفت ‌ |
| ```ErrorDescription``` | ```String``` | توضیح خطای رخ داده ‌ |
| ```ErrorCode``` | ```String``` | کد خطای رخ داده ‌ |


-  متغیر ```Res``` تنها در صورت موفق بودن عملیات با توکن پر می‌شود و در غیر این صورت خالی است.
- در صورتی که عملیات با **خطا** همراه بوده باشد (‍‍‍```State = 0```)، متغیرهای ```ErrorCode``` و ```ErrorDescription``` مقدار می‌گیرند و در صورت موفق بودن عملیات این دو متغیر خالی (```""```) هستند.


پس از دریافت موفقیت‌آمیز توکن، می‌بایست مشتری خود را به سمت درگاه پرداخت اینترنتی هدایت کنید. همچنین باید توجه داشت که توکن دریافتی دارای عمر مصرف است؛ بنابراین پس از مدت زمان مشخصی که مناسب برای انجام یک تراکنش است به پایان رسیده و منقضی می‌شود.

در صورت منقضی شدن توکن، می‌بایست مراحل دریافت توکن و هدایت کاربر به سمت درگاه پرداخت را از نو تکرار نمایید.

**پذیرنده نمی‌تواند از یک توکن مشخص برای هدایت چند مشتری به سمت درگاه پرداخت اینترنتی استفاده کند.**

**پذیرنده موظف است اطلاعات مربوط به هر تراکنش را در سمت خود ذخیره و نگهداری کند.**


## هدایت مشتری به صفحه درگاه پرداخت

| عنوان | توضیحات |
|-|-|
| نام تابع | ```PayStart``` |
| نشانی کامل تابع | ```https://ecd.shaparak.ir/ipg_ecd/PayStart``` |
| نوع تابع | POST |

### مقادیر ارسالی به تابع ```PayStart```


```json
{
    "Token": "C5B2E37396DCC3B654D226FC937BC01F628EC968"
}
```

| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```Token``` | ```String``` | توکن دریافت شده به ازای تراکنش جاری ‌ |


برای فراخوانی تابع ```PayStart``` به همراه هدایت مشتری خود به صفحه درگاه پرداخت می‌توانید از یک فرم به مانند زیر استفاده نمایید:

```html
<form method="post" action="https://ecd.shaparak.ir/ipg_ecd/PayStart">

    <!-- set token -->
    <input type="hidden" name="Token" value="<?php echo $token ?>" />

    <input type="submit" value="پرداخت">

</form>
```

در حال حاضر IP مشتری بررسی می‌شود و باید در حوزه کشور ایران باشد، در غیر این صورت مشتری اجازه ورود به صفحه درگاه پرداخت دماوند را پیدا نمی‌کند.

مشتری در صفحه درگاه پرداخت، مبلغ قابل پرداخت، نام و وب‌سایت پذیرنده را مشاهده می‌کند و می‌تواند از پرداخت انصراف دهد یا اطلاعات کارت بانکی خود را وارد و اقدام به پرداخت نماید که در هر دو صورت به منظور آگاه‌سازی پذیرنده از وضعیت و تکمیل فرآیند پرداخت،‌ مشتری به سمت «نشانی بازگشت وب‌سایت پذیرنده» هدایت می‌شود.


ممکن است دلایلی به مانند قطعی اینترنت مشتری یا بستن برنامه مرورگر توسط مشتری و غیره مانع از هدایت مشتری به وب‌سایت پذیرنده گردند که در این صورت با پایان یافتن زمان مصرف توکن، چنانچه از مشتری پول کسر شده باشد به حساب آن برگشت داده می‌شود و پذیرنده نیز می‌بایست این دست از تراکنش‌های رها شده را به معنی انصراف مشتری از پرداخت در نظر بگیرد.


## بازگشت مشتری به وب‌سایت پذیرنده

هنگام بازگشت مشتری به وب‌سایت پذیرنده، مقادیر زیر در قالب یک شی ```JSON``` و از طریق نوع تابع ```POST``` دریافت می‌شود.

```json
{
    "State": "1",
    "Amount": "10000",
    "ErrorCode": "",
    "ErrorDescription": "",
    "ReferenceNumber": "567890123456",
    "TrackingNumber": "678765",
    "BuyID": "9897676",
    "Token": "C5B2E37396DCC3B654D226FC937BC01F628EC968"
}
```


| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```State``` | ```String``` | نتیجه عملیات: ```"1"```: موفق و ```"0"```: ناموفق ‌ |
| ```Amount``` | ```String``` | مبلغ پرداخت شده توسط مشتری به واحد ریال ‌ |
| ```ErrorDescription``` | ```String``` | توضیح خطای رخ داده ‌ |
| ```ErrorCode``` | ```String``` | کد خطای رخ داده ‌ |
| ```ReferenceNumber``` | ```String``` | شماره ارجاع تراکنش (12 رقم)  |
| ```TrackingNumber``` | ```String``` | شماره پیگیری تراکنش (6 رقم) |
| ```BuyID``` | ```String``` | شناسه خرید - ارسال شده توسط پذیرنده |
| ```Token``` | ```String``` | توکن دریافت شده به ازای تراکنش جاری |

- در صورتی که عملیات با **خطا** همراه بوده باشد (‍‍‍```"State = "0```)، متغیرهای ```ErrorCode``` و ```ErrorDescription``` مقدار می‌گیرند و در صورت موفق بودن عملیات این دو متغیر خالی هستند.


اکنون پذیرنده پس از دریافت این اطلاعات می‌بایست اقدام به بازیابی رکورد ذخیره شده خود نماید، برای این منظور می‌توان از دو مقدار ```BuyID``` یا ```Token``` استفاده کرد. یادآوری می‌شود که تضمین یکتایی مقدار ```BuyID``` بر عهده خود پذیرنده می‌باشد.

پس از یافتن رکورد پیشنهاد می‌شود که پذیرنده مبلغ خود را با مبلغ پرداخت شده توسط مشتری مقایسه نماید. 

در صورت «موفق بودن عملیات»، «یافتن رکورد تراکنش در سمت پذیرنده» و «برابری  مبالغ درخواستی و پرداخت شده»، پذیرنده باید عملیات پرداخت را «تایید» و در غیر این صورت آن را «رد» کند.

بنابراین مواردی که پذیرنده باید **ترکنش را رد کند** عبارتند از:

-  مقادیر بالا به صورت ناقص دریافت شود.
-  فیلد ```State``` برابر با ```"1"``` نباشد.
-  رکورد تراکنش را در سمت خود پیدا نکند.
-  مقدار ```Amount``` (مبلغ پرداخت شده توسط مشتری) با مبلغ تراکنشی که پذیرنده برای درگاه پرداخت ارسال و ذخیره کرده است، برابر نباشد.

**در صورتی که دلایل ارائه شده مبنی بر رد تراکنش در اطلاعات ارسالی وجود نداشته باشد، پذیرنده موظف است تراکنش را تایید کند. در این صورت پذیرنده ابتدا باید تراکنش را تایید و پس از اطمینان از موفق بودن آن، خدمت خود را به مشتری ارائه کند.**

در صورت **رد** تراکنش توسط پذیرنده، چنانچه از مشتری پول کسر شده باشد به حساب آن برگشت داده می‌شود.


## تایید تراکنش

| عنوان | توضیحات |
|-|-|
| نام تابع | ```PayConfirmation``` |
| نشانی کامل تابع | ```https://ecd.shaparak.ir/ipg_ecd/PayConfirmation``` |
| نوع تابع | POST |


### مقادیر ارسالی به تابع ```PayConfirmation```


```json
{
    "Token": "C5B2E37396DCC3B654D226FC937BC01F628EC968"
}
```

| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```Token``` | ```String``` | توکن دریافت شده به ازای تراکنش جاری ‌ |


### مقادیر دریافتی از تابع ```PayConfirmation```


```json
{
    "State": 1,
    "Res": "9897676",
    "ErrorDescription": "", 
    "ErrorCode": ""
}
```

| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```State``` | ```Integer``` | نتیجه عملیات: ```1```: موفق و ```0```: ناموفق ‌ |
| ```Res``` | ```String``` | شناسه خرید - ارسال شده توسط پذیرنده ‌ |
| ```ErrorDescription``` | ```String``` | توضیح خطای رخ داده ‌ |
| ```ErrorCode``` | ```String``` | کد خطای رخ داده ‌ |


-  متغیر ```Res``` تنها در صورت موفق بودن عملیات با «شناسه خرید» پر می‌شود و در غیر این صورت خالی است.
-  در صورتی که عملیات با **خطا** همراه بوده باشد (‍‍‍```State = 0```)، متغیرهای ```ErrorCode``` و ```ErrorDescription``` مقدار می‌گیرند و در صورت موفق بودن عملیات این دو متغیر خالی هستند.

**در صورت ناموفق بودن عملیات تایید تراکنش، نیازی به ارسال درخواست رد تراکنش از سوی پذیرنده نیست چرا که از نظر وب‌سرویس دماوند تراکنش رد شده خواهد بود و پول به حساب مشتری برگشت داده می‌شود.**

**پذیرنده ابتدا باید تراکنش را تایید و تنها پس از اطمینان از موفق بودن آن، خدمت خود را به مشتری ارائه کند.**



## رد تراکنش

| عنوان | توضیحات |
|-|-|
| نام تابع | ```PayReverse``` |
| نشانی کامل تابع | ```https://ecd.shaparak.ir/ipg_ecd/PayReverse``` |
| نوع تابع | POST |


### مقادیر ارسالی به تابع ```PayReverse```


```json
{
    "Token": "C5B2E37396DCC3B654D226FC937BC01F628EC968"
}
```

| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```Token``` | ```String``` | توکن دریافت شده به ازای تراکنش جاری ‌ |


### مقادیر دریافتی از تابع ```PayReverse```


```json
{
    "State": 1,
    "Res": "9897676",
    "ErrorDescription": "", 
    "ErrorCode": ""
}
```

| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```State``` | ```Integer``` | نتیجه عملیات: ```1```: موفق و ```0```: ناموفق ‌ |
| ```Res``` | ```String``` | شناسه خرید - ارسال شده توسط پذیرنده ‌ |
| ```ErrorDescription``` | ```String``` | توضیح خطای رخ داده ‌ |
| ```ErrorCode``` | ```String``` | کد خطای رخ داده ‌ |


-  متغیر ```Res``` تنها در صورت موفق بودن عملیات با «شناسه خرید» پر می‌شود و در غیر این صورت خالی است.
- در صورتی که عملیات با **خطا** همراه بوده باشد (‍‍‍```State = 0```)، متغیرهای ```ErrorCode``` و ```ErrorDescription``` مقدار می‌گیرند و در صورت موفق بودن عملیات این دو متغیر خالی هستند.

**در صورت ناموفق بودن عملیات رد تراکنش، نیازی به ارسال مجدد درخواست رد تراکنش از سوی پذیرنده نیست چرا که از نظر وب‌سرویس دماوند تراکنشی که درخواست تایید با نتیجه موفق از سوی پذیرنده نداشته باشد، رد شده خواهد بود و در صورت کسر مبلغ از حساب مشتری، پول به حساب مشتری برگشت داده می‌شود.**


## خرید با شناسه

با مطالعه موارد بالا شما یک تراکنش «خرید» در سیستم پرداخت به انجام خواهید رساند که می‌توانید با تنظیم مقدار ```BuyNumber``` در بدنه تابع ```PayRequest``` (بخش دریافت توکن) یک «خرید با شناسه» را شروع نمایید. باقی موارد هیچ تفاوتی با یک تراکنش خرید معمولی ندارد.

| عنوان | توضیحات |
|-|-|
| نام تابع | ```PayRequest``` |
| نشانی کامل تابع | ```https://ecd.shaparak.ir/ipg_ecd/PayRequest``` |
| نوع تابع | POST |

### مقادیر ارسالی به تابع ```PayRequest``` برای خرید با شناسه


```json
{
    "TerminalNumber": "99999999",
    "BuyID": "9897676",
    "Amount": 10000,
    "Date": "2018/02/02",
    "Time": "13:22",
    "RedirectURL": "https://example.com/back", 
    "Language": "fa",
    "CheckSum": "356A192B7913B04C54574D18C28D46E6395428AB",

    "BuyNumber": "0000056789"
}
```

**تاکید می‌شود که تنظیم مقدار ```BuyNumber``` در بدنه تابع ```PayRequest``` کاملا اختیاری است ولی باید توجه داشت که با تنظیم این مقدار نوع تراکنش از «خرید» به «خرید با شناسه» تغییر می‌یابد.**

| نام متغیر | نوع متغیر | توضیحات |
|-|-| -|
| ```BuyNumber``` | ```String``` | شناسه خرید - یک عدد با طولی مابین 10 تا 30 رقم ‌ |


**توجه: چنانچه تعداد ارقام شناسه خرید مورد نظر از 10 رقم کمتر است؛ می‌بایست عدد مورد نظر را از سمت چپ با عدد ```0``` تکمیل نمایید تا تعداد ارقام با عدد 10 برابر شود.**



## دانلود نمونه پروژه

برای دریافت نمونه پروژهای اتصال و راه‌اندازی درگاه پرداخت اینترنتی دماوند به زبان‌های برنامه‌نویسی گوناگون می‌توانید به صفحه [گیت‌هاب (github.com/ecd-ipg)](https://github.com/ecd-ipg) اختصاص یافته به این موضوع مراجعه نمایید.



